# tasks file for ai_api
---
- name: "Read the input file to summarize"
  ansible.builtin.slurp:
    src: "{{ input_file }}"
  register: file_data

- name: "Decode the input file content"
  ansible.builtin.set_fact:
    file_content: "{{ file_data.content | b64decode }}"

- name: "Call OpenAI ChatGPT API to generate summary"
  ansible.builtin.uri:
    url: "https://api.openai.com/v1/chat/completions"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ openai_api_key }}"
    body_format: json
    body:
      model: "{{ ai_model }}"
      messages:
        - role: system
          content: "{{ ai_system_prompt }}"
        - role: user
          content: "Summarize the following in layman terms:\n\n{{ file_content }}"
    return_content: yes
  register: ai_response
  failed_when: ai_response.status not in [200, 201]
  changed_when: false

- name: "Extract AI summary from response"
  ansible.builtin.set_fact:
    ai_summary: "{{ ai_response.json.choices[0].message.content | default('No summary returned') }}"

- name: "Save AI summary to output file"
  ansible.builtin.copy:
    dest: "{{ output_file }}"
    content: "{{ ai_summary }}"
    mode: "0644"

- name: "Display summary in output"
  ansible.builtin.debug:
    msg: |
      âœ… AI Summary Generated Successfully:
      
      {{ ai_summary }}

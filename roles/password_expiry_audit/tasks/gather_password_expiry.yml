---
- name: Get list of normal user accounts (UID >= 1000, excluding system accounts)
  command: "awk -F: '$3 >= 1000 && $1 != \"nobody\" {print $1}' /etc/passwd"
  register: normal_users
  changed_when: false

- name: Gather password expiry details for each user
  command: "chage -l {{ item }}"
  loop: "{{ normal_users.stdout_lines }}"
  register: chage_output
  changed_when: false
  failed_when: false

- name: Initialize expiry_info list
  set_fact:
    expiry_info: []

#- name: Build structured expiry data
#  set_fact:
#    expiry_info: "{{ expiry_info + [ {
#        'user': item.item,
#        'expiry_date': expiry_date,
#        'days_left': days_left
#      } ] }}"
#  vars:
#    expiry_date: "{{ (item.stdout | regex_search('Password expires[\\s:]+(.+)', '\\1') | first | default('never')) }}"
#    days_left: >-
#      {% if expiry_date | lower != 'never' %}
#      {{ ((expiry_date | to_datetime('%b %d, %Y')) -
#          (ansible_date_time.date | to_datetime('%Y-%m-%d'))).days }}
#      {% else %}
#      N/A
#      {% endif %}
#  loop: "{{ chage_output.results }}"


- name: Build structured expiry data (password + account expiry + color status)
  set_fact:
    expiry_info: "{{ expiry_info + [ {
        'user': item.item,
        'password_expiry': password_expiry,
        'password_days_left': password_days_left,
        'account_expiry': account_expiry,
        'account_days_left': account_days_left,
        'status_icon': status_icon
      } ] }}"
  vars:
    password_expiry: "{{ (item.stdout | regex_search('Password expires[\\s:]+(.+)', '\\1') | first | default('never')) }}"
    account_expiry:  "{{ (item.stdout | regex_search('Account expires[\\s:]+(.+)', '\\1') | first | default('never')) }}"

    password_days_left: >-
      {% if password_expiry | lower != 'never' %}
      {{ ((password_expiry | to_datetime('%b %d, %Y')) -
          (ansible_date_time.date | to_datetime('%Y-%m-%d'))).days }}
      {% else %}
      N/A
      {% endif %}

    account_days_left: >-
      {% if account_expiry | lower != 'never' %}
      {{ ((account_expiry | to_datetime('%b %d, %Y')) -
          (ansible_date_time.date | to_datetime('%Y-%m-%d'))).days }}
      {% else %}
      N/A
      {% endif %}

        is_alert: >-
      {{
        (password_expiry | lower != 'never'
         and password_days_left != 'N/A'
         and password_days_left | int <= 7)
        or
        (account_expiry | lower != 'never'
         and account_days_left != 'N/A'
         and account_days_left | int <= 7)
      }}

    is_info: >-
      {{
        password_expiry | lower == 'never'
        and account_expiry  | lower == 'never'
      }}

    status_icon: >-
      {% if is_alert %}
      ðŸ”´ ALERT
      {% elif is_info %}
      ðŸŸ  INFO
      {% else %}
      ðŸŸ¢ OK
      {% endif %}

  loop: "{{ chage_output.results }}"


- name: Build consolidated summary dictionary per host
  run_once: true
  set_fact:
    expiry_summary: {}

- name: Aggregate per-host results into expiry_summary
  run_once: true
  set_fact:
    expiry_summary: "{{ expiry_summary | combine({ item: hostvars[item].expiry_info }) }}"
  loop: "{{ ansible_play_hosts }}"

#- name: Build final consolidated text
#  run_once: true
#  set_fact:
#    consolidated_report: |
#      ********************** PASSWORD EXPIRY REPORT **********************
#      Generated: {{ ansible_date_time.iso8601 }}
#      ====================================================================
#      {% for host, users in expiry_summary.items() %}
#      Host: {{ host }}
#      --------------------------------------------------------------------
#      {% for entry in users %}
#        User:        {{ entry.user }}
#        Expiry Date: {{ entry.expiry_date }}
#        Days Left:   {{ entry.days_left }}
#      {% endfor %}
#      --------------------------------------------------------------------
#      {% endfor %}

- name: Build final consolidated text
  run_once: true
  set_fact:
    consolidated_report: |
      ********************** PASSWORD & ACCOUNT EXPIRY REPORT **********************
      Generated: {{ ansible_date_time.iso8601 }}
      ====================================================================
      {% for host, users in expiry_summary.items() %}
      Host: {{ host }}
      --------------------------------------------------------------------
      {% for entry in users %}
        User:             {{ entry.user }}
        Status:           {{ entry.status_icon }}
        Password Expiry:  {{ entry.password_expiry }}
        Days Left:        {{ entry.password_days_left }}
        Account Expiry:   {{ entry.account_expiry }}
        Days Left:        {{ entry.account_days_left }}
      {% endfor %}
      --------------------------------------------------------------------
      {% endfor %}

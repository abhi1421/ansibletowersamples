---
- name: Get list of normal user accounts (UID >= 1000, excluding system accounts)
  command: "awk -F: '$3 >= 1000 && $1 != \"nobody\" {print $1}' /etc/passwd"
  register: normal_users
  changed_when: false

- name: Gather password expiry details for each user
  command: "chage -l {{ item }}"
  loop: "{{ normal_users.stdout_lines }}"
  register: chage_output
  changed_when: false
  failed_when: false

- name: Build structured expiry data
  set_fact:
    expiry_info: "{{ expiry_info | default([]) + [ {
        'user': item.item,
        'expiry_date': (item.stdout | regex_search('Password expires[\\s:]+(.+)', '\\1') | first | default('never')),
        'days_left': (
            (item.stdout | regex_search('Password expires[\\s:]+(.+)', '\\1') | first | default('never') | lower) != 'never'
            | ternary(
                (( (item.stdout | regex_search('Password expires[\\s:]+(.+)', '\\1') | first | to_datetime('%b %d, %Y')) - (ansible_date_time.date | to_datetime('%Y-%m-%d'))).days),
                'N/A'
              )
          )
      } ] }}"
  loop: "{{ chage_output.results }}"

---
- name: Get list of normal user accounts (UID >= 1000, excluding system accounts)
  command: "awk -F: '$3 >= 1000 && $1 != \"nobody\" {print $1}' /etc/passwd"
  register: normal_users
  changed_when: false

- name: Gather password expiry details for each user
  command: "chage -l {{ item }}"
  loop: "{{ normal_users.stdout_lines }}"
  register: chage_output
  changed_when: false
  failed_when: false

- name: Initialize expiry_info list
  set_fact:
    expiry_info: []

- name: Build structured expiry data
  set_fact:
    expiry_info: "{{ expiry_info + [ {
        'user': item.item,
        'expiry_date': expiry_date,
        'days_left': days_left
      } ] }}"
  vars:
    expiry_date: "{{ (item.stdout | regex_search('Password expires[\\s:]+(.+)', '\\1') | first | default('never')) }}"
    days_left: >-
      {% if expiry_date | lower != 'never' %}
      {{ ((expiry_date | to_datetime('%b %d, %Y')) -
          (ansible_date_time.date | to_datetime('%Y-%m-%d'))).days }}
      {% else %}
      N/A
      {% endif %}
  loop: "{{ chage_output.results }}"


- name: Build consolidated summary dictionary per host
  run_once: true
  set_fact:
    expiry_summary: {}

- name: Aggregate per-host results into expiry_summary
  run_once: true
  set_fact:
    expiry_summary: "{{ expiry_summary | combine({ item: hostvars[item].expiry_info }) }}"
  loop: "{{ ansible_play_hosts }}"

- name: Build final consolidated text
  run_once: true
  set_fact:
    consolidated_report: |
      ********************** PASSWORD EXPIRY REPORT **********************
      Generated: {{ ansible_date_time.iso8601 }}
      ====================================================================
      {% for host, users in expiry_summary.items() %}
      Host: {{ host }}
      --------------------------------------------------------------------
      {% for entry in users %}
        User:        {{ entry.user }}
        Expiry Date: {{ entry.expiry_date }}
        Days Left:   {{ entry.days_left }}
      {% endfor %}
      --------------------------------------------------------------------
      {% endfor %}
---
# Main role entry point
- name: Gather password expiry information from remote host
  include_tasks: gather_password_expiry.yml

- name: Append this host's report to a single master file on localhost
  delegate_to: localhost
  become: yes
  block:
    - name: Ensure /var/reports directory exists on control node
      file:
        path: /var/reports
        state: directory
        mode: '0755'

    - name: Append hostname header to master report
      lineinfile:
        path: /var/reports/password_expiry_master_report.txt
        line: "===== {{ inventory_hostname }} ====="
        create: yes
        insertafter: EOF

    - name: Append generated report content
      lineinfile:
        path: /var/reports/password_expiry_master_report.txt
        line: "{{ item }}"
        insertafter: EOF
      loop: "{{ lookup('template', 'password_expiry_report.j2').splitlines() }}"

- name: Ensure local reports directory exists on controller
  delegate_to: localhost
  run_once: true
  file:
    path: "/tmp/reports"
    state: directory
    mode: '0755'

- name: Fetch the master report from EE container to controller
  delegate_to: localhost
  run_once: true
  fetch:
    src: /var/reports/password_expiry_master_report.txt
    dest: /tmp/reports/password_expiry_master_report.txt
    flat: yes
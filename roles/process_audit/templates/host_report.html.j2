<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Process Audit - {{ cur.host }} - {{ cur.when }}</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    h1,h2 { margin: 8px 0; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; vertical-align: top; }
    th { background: #f2f2f2; text-align: left; }
    .risk { background: #fff4f4; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .small { font-size: 12px; color: #444; }
  </style>
</head>
<body>
  <h1>Process Audit Report</h1>
  <div class="small">Host: <b>{{ cur.host }}</b> | Timestamp: {{ cur.when }}</div>

  <h2>Summary</h2>
  <ul>
    <li>Processes: +{{ added.processes|length }} / -{{ removed.processes|length }}</li>
    <li>Listeners: +{{ added.listeners|length }} / -{{ removed.listeners|length }}</li>
    <li>Services: +{{ added.services|length }} / -{{ removed.services|length }}</li>
  </ul>

  <h2>Risk Highlights</h2>
  <table>
    <tr><th>Category</th><th>Count</th></tr>
    <tr class="risk"><td>CPU spikes (&gt;={{ cpu_spike_threshold }}%)</td><td>{{ risks.cpu|length }}</td></tr>
    <tr class="risk"><td>MEM spikes (&gt;={{ mem_spike_threshold }}%)</td><td>{{ risks.mem|length }}</td></tr>
    <tr class="risk"><td>Root processes from /tmp or /var/tmp</td><td>{{ risks.root_tmp|length }}</td></tr>
    <tr class="risk"><td>New non-allowlisted listeners</td><td>{{ risks.ports|length }}</td></tr>
    <tr class="risk"><td>New non-allowlisted processes</td><td>{{ risks.procs|length }}</td></tr>
  </table>

  <h2>New Processes</h2>
  <pre class="mono">{{ (added.processes | sort) | join('\n') }}</pre>

  <h2>Removed Processes</h2>
  <pre class="mono">{{ (removed.processes | sort) | join('\n') }}</pre>

  <h2>New Listeners</h2>
  <pre class="mono">{{ (added.listeners | sort) | join('\n') }}</pre>

  <h2>Removed Listeners</h2>
  <pre class="mono">{{ (removed.listeners | sort) | join('\n') }}</pre>

  <h2>New Services</h2>
  <pre class="mono">{{ (added.services | sort) | join('\n') }}</pre>

  <h2>Stopped Services</h2>
  <pre class="mono">{{ (removed.services | sort) | join('\n') }}</pre>

  <h2>Full Current Snapshot (Counts)</h2>
  <ul class="small">
    <li>Processes: {{ cur.processes|length }}</li>
    <li>Listeners: {{ cur.listeners|length }}</li>
    <li>Running services: {{ cur.services_running|length }}</li>
    <li>Crontabs: {{ (cur.crontabs.splitlines() | reject('match','^###') | list | length) if cur.crontabs else 0 }}</li>
  </ul>
</body>
</html>

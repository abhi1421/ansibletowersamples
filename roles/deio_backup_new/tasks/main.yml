# SPDX-License-Identifier: MIT-0
---
# DEIO Backup Role Tasks

# -------------------------------
# Gather current day and dates
# -------------------------------
- name: Gather current day and dates
  ansible.builtin.set_fact:
    today_day: "{{ lookup('pipe', 'date +%A') }}"
    today_date: "{{ lookup('pipe', 'date +%d-%m-%Y') }}"
    yesterday_date: "{{ lookup('pipe', 'date -d yesterday +%d-%m-%Y') }}"

- name: Set holiday flags
  ansible.builtin.set_fact:
    is_today_holiday: "{{ today_date in holiday_list }}"
    is_yesterday_holiday: "{{ yesterday_date in holiday_list }}"

# -------------------------------
# Compute action flags (weekday + holiday)
# -------------------------------

- name: Compute action flags (weekday + holiday overlap)
  ansible.builtin.set_fact:
    skip_backup: >-
      {% if is_today_holiday and not is_yesterday_holiday %}
        false
      {% elif is_today_holiday and is_yesterday_holiday %}
        true
      {% elif not is_today_holiday and is_yesterday_holiday %}
        true
      {% elif today_day == "Sunday" %}
        true
      {% elif today_day == "Monday" %}
        true
      {% elif today_day == "Saturday" and not is_today_holiday %}
        false
      {% elif today_day in ["Tuesday", "Wednesday", "Thursday", "Friday"] and not is_today_holiday %}
        false
      {% else %}
        true
      {% endif %}
    skip_startup: >-
      {% if is_today_holiday and is_yesterday_holiday %}
        true
      {% elif is_today_holiday %}
        true
      {% elif not is_today_holiday and is_yesterday_holiday %}
        false
      {% elif today_day == "Sunday" %}
        true
      {% elif today_day == "Monday" and not is_today_holiday %}
        false
      {% elif today_day == "Saturday" %}
        true
      {% elif today_day in ["Tuesday", "Wednesday", "Thursday", "Friday"] and not is_today_holiday %}
        false
      {% else %}
        true
      {% endif %}


- name: Normalize skip flags to boolean
  ansible.builtin.set_fact:
    skip_backup: "{{ (skip_backup | string | trim) | bool }}"
    skip_startup: "{{ (skip_startup | string | trim) | bool }}"


- name: Debug computed actions
  ansible.builtin.debug:
    msg: |
      Weekday: {{ today_day }}
      Today: {{ today_date }} (Holiday={{ is_today_holiday }})
      Yesterday: {{ yesterday_date }} (Holiday={{ is_yesterday_holiday }})
      skip_backup={{ skip_backup }}
      skip_startup={{ skip_startup }}



# -------------------------------
# DEBUG-ONLY: Check saa_system status (would run or not)
# -------------------------------
- name: DEBUG: Would check saa_system status?
  ansible.builtin.debug:
    msg: >-
      Will run saa_system status check:
      condition: (not skip_backup) or (not skip_startup) => {{ (not (skip_backup|bool)) or (not (skip_startup|bool)) }}
      note: If this is true, we would execute: "{{ saa_bin }} status"
      saa_status_defined: {{ saa_status is defined }}
      saa_status_stdout: "{{ saa_status.stdout | default('N/A') }}"
  when: (not (skip_backup|bool)) or (not (skip_startup|bool))

## -------------------------------
## Check saa_system status
## -------------------------------
#- name: Check saa_system status
#  ansible.builtin.command: "{{ saa_bin }} status"
#  register: saa_status
#  changed_when: false
#  failed_when: false
#  ignore_errors: true
#  when: (not (skip_backup|bool)) or (not (skip_startup|bool))


# -------------------------------
# DEBUG-ONLY: Stop saa_system if operational (would run or not)
# -------------------------------
- name: DEBUG: Would stop saa_system if operational?
  ansible.builtin.debug:
    msg: >-
      Stop condition evaluation:
      - skip_backup = {{ skip_backup }}
      - Condition `not skip_backup` => {{ not (skip_backup|bool) }}
      - saa_status available => {{ saa_status is defined }}
      - saa_status stdout (lower) => "{{ saa_status.stdout | default('N/A') | lower }}"
      - "'operational' in saa_status.stdout.lower()" => {{ ("operational" in (saa_status.stdout | default('') | lower)) }}
      Note: If all true we would execute: "{{ saa_bin }} stop"
  when:
    - not (skip_backup | bool)

## -------------------------------
## Stop system if backup is planned
## -------------------------------
#- name: Stop saa_system if operational
#  ansible.builtin.shell: "{{ saa_bin }} stop"
#  ignore_errors: true
#  when:
#    - not (skip_backup | bool)
#    - "'operational' in (saa_status.stdout | lower)"

# -------------------------------
# Backup Steps
# -------------------------------

- name: Check utilization of /Archives
  ansible.builtin.shell: "df -h {{ archive_mount }} | awk 'NR==2 {print $5}' | sed 's/%//'"
  register: archive_util
  changed_when: false
  when: not (skip_backup|bool)

- name: Find backup folders
  ansible.builtin.find:
    paths: "{{ backup_base_dir }}"
    file_type: directory
    patterns: "[0-9]*"
  register: backup_dirs
  when: not (skip_backup|bool)

- name: Sort backup folders
  ansible.builtin.set_fact:
    sorted_backups: "{{ backup_dirs.files | map(attribute='path') | sort }}"
  when: not (skip_backup|bool)



# -------------------------------
# DEBUG-ONLY: Delete 2nd last backup decision (would delete or not and why)
# -------------------------------
- name: DEBUG: Would delete 2nd last backup?
  ansible.builtin.debug:
    msg: >-
      Decision for deletion:
      - skip_backup => {{ skip_backup }}
      - not skip_backup => {{ not (skip_backup|bool) }}
      - archive_util defined? => {{ archive_util is defined }}
      - archive_util (int) => {{ archive_util | default('N/A') }}
      - utilization_threshold => {{ utilization_threshold }}
      - sorted_backups defined? => {{ sorted_backups is defined }}
      - sorted_backups length => {{ (sorted_backups | length) if (sorted_backups is defined) else 'N/A' }}
      - Index [-2] exists? => {{ (sorted_backups[-2] is defined) if (sorted_backups is defined) else 'N/A' }}
      - Final evaluation (would delete) => {{
        (not (skip_backup|bool)) and
        (archive_util is defined and (archive_util | int) > utilization_threshold) and
        (sorted_backups is defined and (sorted_backups | length) > 2)
      }}
      If true, we would remove: {{ sorted_backups[-2] | default('N/A') }}
  when:
    - not (skip_backup | bool)

#- name: Delete 2nd last backup if utilization > threshold
#  ansible.builtin.file:
#    path: "{{ sorted_backups[-2] }}"
#    state: absent
#  when:
#    - (not skip_backup) | bool
#    - (archive_util.stdout | int) > utilization_threshold
#    - sorted_backups | length > 2


# -------------------------------
# DEBUG-ONLY: Create today's backup dirs (would create or not)
# -------------------------------
- name: DEBUG: Would create today's backup directories?
  ansible.builtin.debug:
    msg: >-
      Condition `not skip_backup` => {{ not (skip_backup|bool) }}
      Would ensure directories exist:
      - {{ today_backup_dir }}
      - {{ today_db_dir }}
  when: not (skip_backup | bool)


#- name: Create todayâ€™s backup directories
#  ansible.builtin.file:
#    path: "{{ item }}"
#    state: directory
#    mode: "0755"
#  loop:
#    - "{{ today_backup_dir }}"
#    - "{{ today_db_dir }}"
#  when: not (skip_backup|bool)


# -------------------------------
# DEBUG-ONLY: Copy DBRBackup and DBRMirror (would copy or not)
# -------------------------------
- name: DEBUG: Would copy DBRBackup and DBRMirror?
  ansible.builtin.debug:
    msg: >-
      Condition `not skip_backup` => {{ not (skip_backup|bool) }}
      Would run (for each item):
      - cp -pR {{ dbrbackup_src }} {{ today_backup_dir }}/
      - cp -pR {{ dbrmirror_src }} {{ today_backup_dir }}/
  when: not (skip_backup | bool)

  
#- name: Copy DBRBackup and DBRMirror
#  ansible.builtin.command: "cp -pR {{ item }} {{ today_backup_dir }}/"
#  loop:
#    - "{{ dbrbackup_src }}"
#    - "{{ dbrmirror_src }}"
#  when: not (skip_backup|bool)

- name: Find latest SAA_DATA_BACKUP file
  ansible.builtin.shell: |
    ls -1t {{ saa_data_backup_src }}/*SAA_DATA_BACKUP* 2>/dev/null | head -1
  register: latest_backup
  changed_when: false
  failed_when: latest_backup.stdout | trim == ""
  ignore_errors: true
  when: not (skip_backup | bool)

- name: Clean up filename (remove trailing colon)
  ansible.builtin.set_fact:
    latest_backup_clean: "{{ latest_backup.stdout | trim | regex_replace(':$', '') }}"
  when: not (skip_backup | bool)

- name: Debug cleaned path
  ansible.builtin.debug:
    msg: "Copying file: '{{ latest_backup_clean }}' to '{{ today_db_dir }}'"
  when: not (skip_backup | bool)

#- name: Copy latest SAA_DATA_BACKUP file
#  ansible.builtin.command:
#    cmd: "cp -p '{{ latest_backup_clean }}' '{{ today_db_dir }}/'"
#  when: not (skip_backup | bool)

# ---------------
# Startup Step
# ---------------
- name: Simulate SAA system startup
  ansible.builtin.debug:
    msg: >-
      {% if skip_startup | bool %}
        ğŸ”´ Startup skipped today ({{ today_day }})
      {% else %}
        ğŸŸ¢ Startup would have been executed today ({{ today_day }})
      {% endif %}

# -------------------------------
# Startup Step
# -------------------------------
#- name: Start saa_system
#  ansible.builtin.command: "{{ saa_bin }} start operational"
#  ignore_errors: true
#  when: not (skip_startup|bool)


# -------------------------------
# Capture Summary
# -------------------------------
- name: Capture DEIO backup action summary
  ansible.builtin.set_fact:
    deio_backup_result:
      hostname: "{{ inventory_hostname }}"
      day: "{{ today_day }}"
      today_date: "{{ today_date }}"
      yesterday_date: "{{ yesterday_date }}"
      holiday_status: "Today={{ is_today_holiday }}, Yesterday={{ is_yesterday_holiday }}"
      backup_skipped: "{{ skip_backup }}"
      startup_skipped: "{{ skip_startup }}"
      backup_dir: "{{ today_backup_dir | default('N/A') }}"
      db_backup: "{{ today_db_dir | default('N/A') }}"
      disk_util: "{{ archive_util.stdout | default('N/A') }}"
      file_copied: "{{ latest_backup_clean | default('N/A') }}"
      system_status_before: "{{ saa_status.stdout | default('Unknown') }}"
      system_status_after: "{{ system_after_status.stdout | default('Unknown') }}"


- name: Gather all backup results on controller
  ansible.builtin.set_fact:
    all_backup_results: "{{ hostvars | dict2items | map(attribute='value.deio_backup_result') | select('defined') | list }}"
  run_once: true

- name: Build combined email body
  ansible.builtin.set_fact:
    deio_email_body: |
      Hello Team,

      Hereâ€™s the consolidated DEIO Backup Summary for {{ today_date }}:

      {% for result in all_backup_results %}
      ------------------------------------------------------------------
      ğŸ”¹ Server: {{ result.hostname }}
      ğŸ”¸ Day: {{ result.day }}
      ğŸ”¸ Backup Performed: {{ (not result.backup_skipped) | ternary('Yes', 'No (Skipped)') }}
      ğŸ”¸ Startup Performed: {{ (not result.startup_skipped) | ternary('Yes', 'No (Skipped)') }}
      ğŸ”¸ Backup Directory: {{ result.backup_dir }}
      ğŸ”¸ DB Backup Directory: {{ result.db_backup }}
      ğŸ”¸ Disk Utilization: {{ result.disk_util }}%
      ğŸ”¸ File Copied: {{ result.file_copied }}
      ------------------------------------------------------------------

      {% endfor %}
      Regards,
      DEIO Backup Automation
  run_once: true

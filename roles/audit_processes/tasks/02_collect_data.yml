- name: Generate today's executed commands snapshot
  shell: |
    ausearch -k process_exec --start today \
    | grep exe= \
    | awk -F 'exe=' '{print $2}' \
    | awk '{print $1}' \
    | sort | uniq > /tmp/today.log
  changed_when: false

- name: Generate yesterday's executed commands snapshot
  shell: |
    ausearch -k process_exec --start yesterday --end yesterday \
    | grep exe= \
    | awk -F 'exe=' '{print $2}' \
    | awk '{print $1}' \
    | sort | uniq > /tmp/yesterday.log
  changed_when: false

- name: Identify newly executed commands today
  command: comm -13 /tmp/yesterday.log /tmp/today.log
  register: new_today_exec
  changed_when: false

- name: Count today's executed commands
  command: wc -l /tmp/today.log
  register: today_count
  changed_when: false

- name: Count yesterday's executed commands
  command: wc -l /tmp/yesterday.log
  register: yesterday_count
  changed_when: false

- name: Store host audit data
  set_fact:
    process_exec_host_report:
      host: "{{ inventory_hostname }}"
      today_count: "{{ today_count.stdout.split()[0] | int }}"
      yesterday_count: "{{ yesterday_count.stdout.split()[0] | int }}"
      new_commands: "{{ new_today_exec.stdout_lines | default([]) }}"

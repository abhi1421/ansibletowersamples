- name: Generate today's executed commands snapshot
  shell: |
    ausearch -k process_exec --start today \
    | grep exe= \
    | awk -F 'exe=' '{print $2}' \
    | awk '{print $1}' \
    | sort | uniq > /tmp/today.log
  changed_when: false

- name: Generate yesterday's executed commands snapshot
  shell: |
    ausearch -k process_exec --start yesterday --end yesterday \
    | grep exe= \
    | awk -F 'exe=' '{print $2}' \
    | awk '{print $1}' \
    | sort | uniq > /tmp/yesterday.log
  changed_when: false

- name: Identify newly executed commands today
  command: comm -13 /tmp/yesterday.log /tmp/today.log
  register: new_today_exec
  changed_when: false


- name: Store host audit data
  set_fact:
    process_exec_host_report:
      host: "{{ inventory_hostname }}"
      today_count: "{{ lookup('file', '/tmp/today.log').splitlines() | length }}"
      yesterday_count: "{{ lookup('file', '/tmp/yesterday.log').splitlines() | length }}"
      new_commands: "{{ new_today_exec.stdout_lines | default([]) }}"


- name: Collect audit facts from all hosts
  set_fact:
    consolidated_audit_report: |
      Process Execution Audit â€“ Consolidated Report
      =============================================
      Date: {{ lookup('pipe', 'date +%F') }}
      
      
      {% for host in groups['all'] %}
      Host: {{ host }}
      -----------------------------
      Commands executed yesterday: {{ hostvars[host].process_exec_host_report.yesterday_count }}
      Commands executed today: {{ hostvars[host].process_exec_host_report.today_count }}
      
      
      Newly executed commands today:
      {% if hostvars[host].process_exec_host_report.new_commands | length > 0 %}
      {% for cmd in hostvars[host].process_exec_host_report.new_commands %}
      - {{ cmd }}
      {% endfor %}
      {% else %}
      No changes detected
      {% endif %} 
      {% endfor %}

- name: Extract today's executed commands
  shell: |
    ausearch -k {{ audit_rule_key }} --start today \
    | grep exe= \
    | awk -F 'exe=' '{print $2}' \
    | awk '{print $1}' \
    | sort | uniq
  register: today_exec
  changed_when: false


- name: Extract yesterday's executed commands
  shell: |
    ausearch -k {{ audit_rule_key }} --start yesterday --end yesterday \
    | grep exe= \
    | awk -F 'exe=' '{print $2}' \
    | awk '{print $1}' \
    | sort | uniq
  register: yesterday_exec
  changed_when: false


- name: Identify newly executed processes today
  shell: |
    comm -13 <(printf "%s\n" {{ yesterday_exec.stdout_lines | join(' ') }}) \
    <(printf "%s\n" {{ today_exec.stdout_lines | join(' ') }})
  args:
    executable: /bin/bash
  register: new_today_exec
  changed_when: false

- name: Store per-host audit data as fact
  set_fact:
    process_exec_host_report:
      host: "{{ inventory_hostname }}"
      date: "{{ ansible_date_time.date }}"
      yesterday_count: "{{ yesterday_exec.stdout_lines | length }}"
      today_count: "{{ today_exec.stdout_lines | length }}"
      new_commands: "{{ new_today_exec.stdout_lines | default([]) }}"

- name: Collect audit facts from all hosts
  set_fact:
    consolidated_audit_report: |
      Process Execution Audit â€“ Consolidated Report
      =============================================
      Date: {{ lookup('pipe', 'date +%F') }}
      
      
      {% for host in groups['all'] %}
      Host: {{ host }}
      -----------------------------
      Commands executed yesterday: {{ hostvars[host].process_exec_host_report.yesterday_count }}
      Commands executed today: {{ hostvars[host].process_exec_host_report.today_count }}
      
      
      Newly executed commands today:
      {% if hostvars[host].process_exec_host_report.new_commands | length > 0 %}
      {% for cmd in hostvars[host].process_exec_host_report.new_commands %}
      - {{ cmd }}
      {% endfor %}
      {% else %}
      No changes detected
      {% endif %} 
      {% endfor %}

---
# Implementation tasks for System Updates - Builtin Modules Only

- name: Hardening | Ensure GPG Check is globally enabled in DNF
  ansible.builtin.lineinfile:
    path: /etc/dnf/dnf.conf
    regexp: '^gpgcheck='
    line: 'gpgcheck=1'
    state: present
    create: yes

- name: Hardening | Ensure Red Hat GPG keys are imported
  ansible.builtin.rpm_key:
    key: "{{ item }}"
    state: present
  loop:
    - /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
    - /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-compliance
  ignore_errors: yes 

- name: Hardening | Check Satellite/RHSM registration status
  ansible.builtin.command: subscription-manager identity
  register: rhsm_identity
  changed_when: false
  failed_when: false

- name: Hardening | Set system to the highest approved release version
  ansible.builtin.command: "subscription-manager release --set={{ allowed_rhel_versions | sort | last }}"
  register: release_set_result
  changed_when: "'Release set to' in release_set_result.stdout"
  # Only attempt if the system is actually registered
  when: 
    - rhsm_identity.rc == 0
    - ansible_facts.distribution == 'RedHat'
    - current_rhel_version is defined
    - current_rhel_version != (allowed_rhel_versions | sort | last)

- name: Compliance | Log Update Configuration Implementation
  ansible.builtin.set_fact:
    compliance_report_results: "{{ compliance_report_results + [{
      'category': 'System Updates',
      'item': 'Subscription and GPG Enforcement',
      'status': 'ENFORCED',
      'details': 'DNF GPG check enabled. GPG keys imported. Satellite Status: ' + ('Registered' if rhsm_identity.rc == 0 else 'Not Registered')
    }] }}"

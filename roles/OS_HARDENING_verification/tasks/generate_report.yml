---
# os_hardening_verification/tasks/generate_report.yml
# This file compiles all compliance check results and generates a human-readable report.

- name: Prepare report content
  ansible.builtin.set_fact:
    report_content: |
      # Compliance Report for Host: {{ ansible_hostname }} ({{ ansible_default_ipv4.address }})
      ## Date: {{ ansible_date_time.iso8601_micro }}

      This report summarizes the compliance status of the host against the defined hardening requirements.

      ### Summary of Compliance Status:
      - **COMPLIANT:** {{ compliance_report_results | selectattr('status', 'equalto', 'COMPLIANT') | list | length }} items
      - **NON_COMPLIANT:** {{ compliance_report_results | selectattr('status', 'equalto', 'NON_COMPLIANT') | list | length }} items
      - **MANUAL_REQUIRED:** {{ compliance_report_results | selectattr('status', 'equalto', 'MANUAL_REQUIRED') | list | length }} items

      ### Detailed Compliance Information:

      {% for category in compliance_report_results | map(attribute='category') | unique | sort %}
      #### {{ category }}

      | Item | Status | Expected | Actual | Message |
      |---|---|---|---|---|
      {% for item in compliance_report_results | selectattr('category', 'equalto', category) %}
      | {{ item.item }} | **{{ item.status }}** | {{ item.expected }} | {{ item.actual }} | {{ item.message }} |
      {% endfor %}

      {% endfor %}
  # This Jinja2 template generates a Markdown-formatted report.
  # It groups results by category for better readability.
  tags:
    - always
    - report_generation # Tag for report generation

- name: Display compliance report (console output)
  ansible.builtin.debug:
    msg: "{{ report_content }}"
  # Output the report to the console for immediate viewing.
  tags:
    - always
    - report_generation


- name: Construct the consolidated email body
  ansible.builtin.set_fact:
    email_summary_body: |
      OS Hardening Verification Summary
      Execution Date: {{ ansible_date_time.date }}
      -----------------------------------------
      {% for host in ansible_play_hosts %}
      Host: {{ host }}
      - Compliant:     {{ hostvars[host]['comp_count'] | default(0) }}
      - Non-Compliant: {{ hostvars[host]['non_comp_count'] | default(0) }}
      - Manual Check:  {{ hostvars[host]['manual_count'] | default(0) }}
      -----------------------------------------
      {% endfor %}
      
      Detailed Markdown reports are available on the Ansible Controller.
  delegate_to: localhost
  run_once: true


## NEW ADDITION
- name: Define report filename
  ansible.builtin.set_fact:
    report_filename: "/tmp/compliance_report_{{ ansible_facts.default_ipv4.address | replace('.', '-') }}_{{ ansible_date_time.date | replace('-', '') }}.md"
  tags:
    - always
    - report_generation

- name: Save compliance report to file on target host
  ansible.builtin.copy:
    content: "{{ report_content }}"
    dest: "{{ report_filename }}"
    mode: '0644'
  tags:
    - always
    - report_generation

- name: Create destination directory on control node
  ansible.builtin.file:
    path: /home/ansible/reports/jobs/hardeningverify/{{ ansible_facts.default_ipv4.address | replace('.', '-') }}/
    state: directory
    mode: '0755'
  delegate_to: localhost
  become: no
  run_once: true
  tags:
    - always
    - report_generation

- name: Fetch report file to Ansible control node
  ansible.builtin.fetch:
    src: "{{ report_filename }}"
    dest: "/mnt/host_share/"
#    dest: "/home/ansible/reports/jobs/hardeningverify/{{ ansible_facts.default_ipv4.address | replace('.', '-') }}/"
    flat: yes
  tags:
    - always
    - report_generation

## END OF NEW ADDITION


#- name: Define report filename
#  ansible.builtin.set_fact:
#    report_filename: "/tmp/compliance_report_{{ ansible_facts.default_ipv4.address | replace('.', '-') }}_{{ ansible_date_time.iso8601_basic | replace('T', '_') | replace('Z', '') | replace('-', '') | replace(':', '') }}.md"
#  tags:
#    - always
#    - report_generation
#
#- name: Save compliance report to file on target host
#  ansible.builtin.copy:
#    content: "{{ report_content }}"
#    dest: "{{ report_filename }}"
#    mode: '0644'
#  tags:
#    - always
#    - report_generation
#
#- name: Fetch report file to Ansible control node
#  ansible.builtin.fetch:
#    src: "{{ report_filename }}"
#    dest: /mnt/host_share/
#    flat: yes
#  tags:
#    - always
#    - report_generation
#
#- name: Copy the fetched file to /hime/ansible directory
#  copy: 
#
#- name: Check if /mnt/host_share/{{ report_filename }} exists on Ansible controller
#  stat:
#    path: /mnt/host_share/{{ report_filename }}
#  register: controller_file_stat
#  delegate_to: localhost
#
#- name: Debug the controller file
#  debug:
#    var: controller_file_stat



##Commented section
#- name: Save compliance report to file
#  ansible.builtin.copy:
#    content: "{{ report_content }}"
#    dest: "/tmp/compliance_report_{{ ansible_hostname }}_{{ ansible_date_time.iso8601 }}.md"
#    mode: '0644'
#  # Save the report to a file on the target host.
#  # The filename includes hostname and timestamp for uniqueness.
#  tags:
#    - report_generation
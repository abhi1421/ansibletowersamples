---
- name: Configure Instana setenv file (Standalone Playbook)
  hosts: all # Replace with your actual host/group
  become: true             # Add if privileged access is needed for /opt/instana/agent/bin/setenv

  tasks:
    - name: Define Instana setenv file path and lines
      ansible.builtin.set_fact:
        instana_setenv_path: "/opt/instana/agent/bin/setenv"
        instana_setenv_lines:
          - "INSTANA_APPEND_FQDN_TO_AGENT_ID=true"
          - "export INSTANA_APPEND_FQDN_TO_AGENT_ID"
      tags: [configure_setenv]
      # Define the target file path and the lines to be added.

    - name: Check if Instana setenv file exists
      ansible.builtin.stat:
        path: "{{ instana_setenv_path }}"
      register: setenv_file_stat
      tags: [configure_setenv]
      # Check the status of the setenv file to determine if it needs to be created.

    - name: Create parent directory for Instana setenv file if it does not exist
      ansible.builtin.file:
        path: "{{ instana_setenv_path | ansible.builtin.dirname }}" # Get the directory part of the path
        state: directory
        mode: '0755' # Standard directory permissions
        owner: root
        group: root
        recurse: true # Create parent directories if they do not exist
      when: not setenv_file_stat.stat.exists # Only create if the file itself doesn't exist
      tags: [configure_setenv]
      # Ensure the parent directory for the setenv file exists, creating any missing parent directories.

    - name: Create Instana setenv file if it does not exist
      ansible.builtin.file:
        path: "{{ instana_setenv_path }}"
        state: file # Ensure it's a file
        mode: '0644' # Standard file permissions
        owner: root
        group: root
      when: not setenv_file_stat.stat.exists
      tags: [configure_setenv]
      # Create the setenv file itself if the stat check revealed it's missing.

    - name: Echo message after ensuring setenv file existence
      ansible.builtin.debug:
        msg: "Instana setenv file '{{ instana_setenv_path }}' ensured."
      tags: [configure_setenv]

    - name: Add/Ensure specific lines in Instana setenv file
      ansible.builtin.lineinfile:
        path: "{{ instana_setenv_path }}"
        line: "{{ item }}"
        state: present # Ensures the line is present; if it exists, it won't be added again.
        insertafter: EOF # Add lines at the end of the file.
      loop: "{{ instana_setenv_lines }}"
      tags: [configure_setenv]
      # Loop through the defined lines and ensure each one is present in the setenv file.
      # 'state: present' handles idempotency, adding lines only if they don't already exist.

    - name: Echo message after configuring setenv file
      ansible.builtin.debug:
        msg: "Lines added/ensured in '{{ instana_setenv_path }}'."
      tags: [configure_setenv]
---
# quay_cve_sync_refined/tasks/upload_phase.yml

- name: Set today's date for consistent file naming (re-set for this play's scope)
  ansible.builtin.set_fact:
    today_date: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"
  run_once: true

- name: Ensure the Quay CVE upload directory exists on the upload node (as core user)
  ansible.builtin.file:
    path: "{{ quay_cve_upload_dir }}"
    state: directory
    mode: '0755'
    owner: core
    group: core

- name: Copy Quay CVE files from Ansible control node to upload host
  ansible.builtin.copy:
    src: "/var/tmp/{{ item.filename }}"
    dest: "{{ quay_cve_upload_dir }}/{{ item.filename }}"
    mode: '0644'
    force: yes
    remote_src: yes
  loop:
    - { filename: "{{ repo2cpe_filename }}" }
    - { filename: "{{ container_map_filename }}" }
    - { filename: "{{ updates_gz_filename }}" }
  loop_control:
    label: "{{ item.filename }}"

- name: Curl the domain
  command: curl -kvv https://api.ek3nphub.rbi1.rbi.org.in:6443

- name: Login to the hub cluster in order to perform upload tasks
  command: oc login --server https://api.ek3nphub.rbi1.rbi.org.in:6443 -uocpadmin -pRbi@12345 --insecure-skip-tls-verify=true --v=8
#  args:
#    timeout: 60
#  retries: 5
#  delay: 10

- name: Check hub login status
  shell: oc whoami --show-console
  register: hublogin_status

- name: Show hub login status
  debug: 
    var: hublogin_status  

- name: Create ubi-minimal pod definition file on upload host
  ansible.builtin.template:
    src: "{{ playbook_dir }}/roles/PATCHING_quay_cve_sync/templates/ubi-minimal-pod.yaml.j2"
    dest: "{{ quay_cve_upload_dir }}/ubi-minimal-pod-{{ ansible_hostname | lower | replace('-', '') }}.yaml"
    mode: '0644'
    owner: core
    group: core

- name: Apply ubi-minimal pod on upload host
  ansible.builtin.command: "oc apply -f {{ quay_cve_upload_dir }}/ubi-minimal-pod-{{ ansible_hostname | lower | replace('-', '') }}.yaml -n {{ quay_namespace }}"
  register: oc_apply_pod_result
  changed_when: "'created' in oc_apply_pod_result.stdout or 'configured' in oc_apply_pod_result.stdout"
  failed_when: oc_apply_pod_result.rc != 0

- name: Wait for ubi-minimal pod to be running
  ansible.builtin.shell: >
    oc get pod ubi-minimal-{{ ansible_hostname | lower | replace('-', '') }}-{{ ansible_date_time.epoch }} -n {{ quay_namespace }} -o jsonpath='{.status.phase}'
  register: pod_status
  until: pod_status.stdout == "Running"
  retries: 30 # Retry for 5 minutes (30 * 10 seconds)
  delay: 10 # Check every 10 seconds
  changed_when: false # This task doesn't change anything

- name: Copy JSON and GZ files into ubi-minimal pod's /data path
  ansible.builtin.command: >
    oc cp {{ quay_cve_upload_dir }}/{{ item.filename }}
    ubi-minimal-{{ ansible_hostname | lower | replace('-', '') }}-{{ ansible_date_time.epoch }}:/data/{{ item.filename }}
    -n {{ quay_namespace }}
  loop:
    - { filename: "{{ repo2cpe_filename }}" }
    - { filename: "{{ container_map_filename }}" }
  loop_control:
    label: "{{ item.filename }}"
  register: oc_cp_result
  changed_when: oc_cp_result.rc == 0
  failed_when: oc_cp_result.rc != 0

- name: Kill any existing process on port 5432
  shell: > 
    lsof -t -i:5432 | xargs -r kill -9
  changed_when: true
  failed_when: false
  become: yes
  become_user: core

- name: Start Clair DB port-forward in background
  ansible.builtin.shell: oc port-forward svc/{{ clair_postgres_service }} 5432:5432 -n {{ quay_namespace }}
  async: 3600
  poll: 0  
#    oc port-forward svc/clair-postgres 5432:5432 -n image-registry > /dev/null 2>&1 & echo $!
  args:
    chdir: "{{ quay_cve_upload_dir }}" # Run from a known directory
  register: port_forward_pid
  changed_when: false # This task doesn't change system state in a persistent way
  # Add a short pause to allow port-forward to establish
  become: yes
  become_user: core
  # 
- name: Pause to allow port-forward to establish
  ansible.builtin.pause:
    seconds: 60

- name: Wait for port 5432 to be available with retires
  ansible.builtin.wait_for:
    port: 5432
    host: 127.0.0.1
    state: started
    delay: 20
    timeout: 120
  retries: 5
  delay: 20


- name: Telnet to check port
  shell: nc -zv 127.0.0.1 5432
  register: telnetcheck
  args:
#    timeout: 60
#  until: telnetcheck.rc == 0
#  retries: 5
#  delay: 10

- name: Import CVE updates to Clair DB using clairctl (local connection via port-forward)
  # This clairctl command will connect to localhost:5432 due to the port-forward.
  ansible.builtin.command: >
    clairctl --config  {{ quay_cve_upload_dir }}/clair-config.yaml import-updaters {{ quay_cve_upload_dir }}/{{ updates_gz_filename }}
  register: clairctl_import_result
  changed_when: clairctl_import_result.rc == 0
  failed_when: clairctl_import_result.rc != 0


- name: Cleanup CVE downloaded files from tmp folder
  file:
    path: "/tmp/{{ item.filename }}"
    state: absent
  become: true
  become_user: root
  loop:
    - { filename: "{{ repo2cpe_filename }}" }
    - { filename: "{{ container_map_filename }}" }
    - { filename: "{{ updates_gz_filename }}" }
  loop_control:
    label: "{{ item.filename }}"

- name: Cleanup CVE downloaded files from {{ quay_cve_upload_dir }}
  file:
    path: "{{ quay_cve_upload_dir }}/{{ item.filename }}"
    state: absent
  become: true
  loop:
    - { filename: "{{ repo2cpe_filename }}" }
    - { filename: "{{ container_map_filename }}" }
    - { filename: "{{ updates_gz_filename }}" }
  loop_control:
    label: "{{ item.filename }}"

- name: Kill Clair DB port-forward process
  ansible.builtin.shell: >
    lsof -t -i:5432 | xargs -r kill -9
#  when: port_forward_pid.stdout is defined and port_forward_pid.stdout | length > 0
  changed_when: false # This task doesn't change system state in a persistent way
  failed_when: false # Don't fail if kill command fails (e.g., process already gone)

- name: Delete ubi-minimal pod
  ansible.builtin.command: "oc delete pod ubi-minimal-{{ ansible_hostname | lower | replace('-', '') }}-{{ ansible_date_time.epoch }} -n {{ quay_namespace }}"
  register: oc_delete_pod_result
  changed_when: "'deleted' in oc_delete_pod_result.stdout"
  failed_when: oc_delete_pod_result.rc != 0 and "not found" not in oc_delete_pod_result.stderr

- name: Build upload summary
  ansible.builtin.set_fact:
    upload_summary:
      date: "{{ today_date }}"
      host: "{{ inventory_hostname }}"
      upload_status: "{{ clairctl_import_result.rc | default('NA') }}"
      upload_message: >-
        {% if clairctl_import_result.rc is defined and clairctl_import_result.rc == 0 %}
        CVE data imported into CLair successfully.
        {% else %}
        Upload failed or partially failed. Check logs.
        {% endif %}

- name: Expose upload summary to workflow
  ansible.builtin.set_stats:
    data:
      upload_summary: "{{ upload_summary }}"

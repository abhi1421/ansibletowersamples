---
- name: Master Consolidated Reporting
  hosts: localhost
  gather_facts: true

  tasks:

    - name: Initialize variables from workflow
      set_fact:
        health_data: "{{ all_health_reports | default([]) }}"

    - name: Filter only critical health alerts
      set_fact:
        critical_health: "{{ health_data | selectattr('alert','equalto', true) | list }}"

    - name: Build email body as variable
      set_fact:
        combined_email_body: |
          <h2>Combined Monitoring Report</h2>
          <p>Generated: {{ ansible_date_time.date }} {{ ansible_date_time.time }}</p>

          <hr>

          <h3>DAILY HEALTH CHECK – CRITICAL ALERTS</h3>

          {% if critical_health | length > 0 %}

          <table border="1" cellpadding="5" cellspacing="0">
          <tr style="background-color:#f2f2f2">
            <th>Hostname</th>
            <th>CPU Load</th>
            <th>Memory Usage (%)</th>
            <th>Disk Usage (%)</th>
            <th>I/O Wait</th>
            <th>Status</th>
          </tr>

          {% for report in critical_health %}
          <tr>
            <td>{{ report.system_hostname }}</td>
            <td>{{ report.cpu_load }}</td>
            <td>{{ report.mem_usage }}</td>
            <td>{{ report.disk_usage }}</td>
            <td>{{ report.iowait }}</td>
            <td style="color:red"><b>CRITICAL</b></td>
          </tr>
          {% endfor %}

          </table>

          {% else %}

          <p style="color:green"><b>No Critical Health Alerts Detected</b></p>

          {% endif %}

          <hr>
          <p><i>This is an auto-generated consolidated monitoring summary.</i></p>

- name: Display formatted email body
  debug:
    msg: "{{ combined_email_body }}"


#    - name: Send consolidated report email
#      community.general.mail:
#        host: 10.35.1.17
#        port: 25
#        to: "{{ email_recepients | join(', ') }}"
#        from: ansible.alerts@rbi.org.in
#        subject: "Combined Monitoring Report – Critical Summary"
#        subtype: html
#        body: "{{ combined_email_body }}"
#      run_once: true


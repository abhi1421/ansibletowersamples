---
- name: Master Consolidated Reporting
  hosts: localhost
  gather_facts: true

  tasks:
##################################
#Daily health check section
##################################
    - name: Initialize variables from workflow
      set_fact:
        health_data: "{{ all_health_reports | default([]) }}"

    - name: Filter only critical health alerts
      set_fact:
        critical_health: "{{ health_data | selectattr('alert','equalto', true) | list }}"

##################################
#Process Audit section
##################################
    - name: Initialize process audit data from workflow
      set_fact:
        audit_data: "{{ all_process_audit | default([]) }}"
  
    - name: Filter hosts with new commands
      set_fact:
        critical_audit: "{{ audit_data | selectattr('has_new_commands','equalto', true) | list }}"

##################################
# Password Expiry section
##################################

    - name: Initialize password expiry data from workflow
      set_fact:
        password_data: "{{ password_expiry_metrics | default([]) if (password_expiry_metrics is defined and password_expiry_metrics is iterable) else [] }}"
    
    - name: Filter hosts with expiring users
      set_fact:
        critical_password: "{{ password_data | selectattr('has_expiring_users','defined') | selectattr('has_expiring_users','equalto', true) | list }}"




##################################
## MAIN EMAIL SECTION
##################################
#
#    - name: Build Markdown formatted email body
#      set_fact:
#        combined_email_body: |
#          COMBINED MONITORING REPORT
#          Generated: {{ ansible_date_time.date }} {{ ansible_date_time.time }}            
#          ============================================================
#          DAILY HEALTH CHECK – CRITICAL ALERTS
#          {% if critical_health | length > 0 %}
#          Hostname           CPU Load   Memory%   Disk%
#          ----------------------------------------------
#          {% for report in critical_health %}
#          {{ "%-18s %-10s %-9s %-7s" | format(report.system_hostname, report.cpu_load, report.mem_usage, report.disk_usage | default('N/A')) }}
#          {% endfor %}
#          {% else %}
#          No Critical Health Alerts Detected
#          {% endif %}
#          ============================================================
#          ============================================================
#          PROCESS AUDIT NEW COMMANDS
#          {% if critical_audit | length > 0 %}
#          Hostname           New Commands
#          -----------------------------------------------------------
#          {% for item in critical_audit %}
#          {% if item.new_commands | length > 0 %}
#          {{ "%-18s %-s" | format(item.system_hostname, item.new_commands[0]) }}
#          {% for cmd in item.new_commands[1:] %}
#          {{ "%-18s %-s" | format(" ", cmd) }}
#          {% endfor %}
#          {% endif %}
#          {% endfor %}
#          {% else %}
#          No new commands detected
#          {% endif %}
#          ============================================================
#          ============================================================
#          PASSWORD EXPIRY ALERTS       
#          {% if critical_password | length > 0 %}        
#          Hostname           User              Days Left
#          -----------------------------------------------------------
#          {% for host in critical_password %}
#          {% for user in host.expiring_users %}
#          {{ "%-18s %-17s %-10s" | format(host.system_hostname, user.user, user.password_days_left) }}
#          {% endfor %}
#          {% endfor %}
#          {% else %}
#          No expiring passwords detected
#          {% endif %}
#          ============================================================


    - name: Build HTML formatted email body
      set_fact:
        combined_email_body: |
          <html>
          <body style="font-family: Arial, sans-serif; font-size: 13px;">
    
          <h2>Combined Monitoring Report</h2>
          <p><strong>Generated:</strong> {{ ansible_date_time.date }} {{ ansible_date_time.time }}</p>
    
          <hr>
    
          <h3>Daily Health Check – Critical Alerts</h3>
          {% if critical_health | length > 0 %}
          <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
            <tr>
              <th>Hostname</th>
              <th>CPU Load</th>
              <th>Memory %</th>
              <th>Disk %</th>
              <th>IOWait %</th>
            </tr>
            {% for report in critical_health %}
            <tr>
              <td>{{ report.system_hostname }}</td>
              <td>{{ report.cpu_load }}</td>
              <td>{{ report.mem_usage }}</td>
              <td>{{ report.disk_usage | default('N/A') }}</td>
              <td>{{ report.iowait | default('N/A') }}</td>
            </tr>
            {% endfor %}
          </table>
          {% else %}
          <p>No Critical Health Alerts Detected</p>
          {% endif %}
    
          <hr>
    
          <h3>Process Audit – New Commands</h3>
          {% if critical_audit | length > 0 %}
          <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
            <tr>
              <th>Hostname</th>
              <th>Command</th>
            </tr>
            {% for item in critical_audit %}
              {% for cmd in item.new_commands %}
              <tr>
                <td>{{ item.system_hostname }}</td>
                <td>{{ cmd }}</td>
              </tr>
              {% endfor %}
            {% endfor %}
          </table>
          {% else %}
          <p>No New Commands Detected</p>
          {% endif %}
    
          <hr>
    
          <h3>Password Expiry Alerts</h3>
          {% if critical_password | length > 0 %}
          <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
            <tr>
              <th>Hostname</th>
              <th>User</th>
              <th>Days Left</th>
            </tr>
            {% for host in critical_password %}
              {% for user in host.expiring_users %}
              <tr>
                <td>{{ host.system_hostname }}</td>
                <td>{{ user.user }}</td>
                <td>{{ user.password_days_left }}</td>
              </tr>
              {% endfor %}
            {% endfor %}
          </table>
          {% else %}
          <p>No Expiring Passwords Detected</p>
          {% endif %}
    
          <hr>
    
          <p style="font-size:12px; color:gray;">
          This is an automated monitoring report generated by Ansible.
          </p>
    
          </body>
          </html>


    - name: Display formatted email body
      debug:
        msg: "{{ combined_email_body }}"


#    - name: Send consolidated report email
#      community.general.mail:
#        host: 10.35.1.17
#        port: 25
#        to: "{{ email_recepients | join(', ') }}"
#        from: ansible.alerts@rbi.org.in
#        subject: "Combined Monitoring Report – Critical Summary"
#        subtype: html
#        body: "{{ combined_email_body }}"
#      run_once: true


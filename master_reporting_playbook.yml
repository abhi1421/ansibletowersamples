---
- name: Master Consolidated Reporting
  hosts: localhost
  gather_facts: true

  tasks:

    - name: Initialize variables from workflow
      set_fact:
        health_data: "{{ all_health_reports | default([]) }}"

    - name: Filter only critical health alerts
      set_fact:
        critical_health: "{{ health_data | selectattr('alert','equalto', true) | list }}"

    - name: Build Markdown formatted email body
      set_fact:
        combined_email_body: |
          COMBINED MONITORING REPORT
          Generated: {{ ansible_date_time.date }} {{ ansible_date_time.time }}            
          ============================================================
          DAILY HEALTH CHECK – CRITICAL ALERTS
          {% if critical_health | length > 0 %}
          Hostname           CPU Load   Memory%   Disk%
          ----------------------------------------------
          {% for report in critical_health %}
          {{ "%-18s %-10s %-9s %-7s" | format(report.system_hostname, report.cpu_load, report.mem_usage, report.disk_usage | default('N/A')) }}
          {% endfor %}
    
          {% else %}
    
          No Critical Health Alerts Detected
    
          {% endif %}
          ============================================================
    
          This is an auto-generated consolidated monitoring summary.

    - name: Display formatted email body
      debug:
        msg: "{{ combined_email_body }}"


#    - name: Send consolidated report email
#      community.general.mail:
#        host: 10.35.1.17
#        port: 25
#        to: "{{ email_recepients | join(', ') }}"
#        from: ansible.alerts@rbi.org.in
#        subject: "Combined Monitoring Report – Critical Summary"
#        subtype: html
#        body: "{{ combined_email_body }}"
#      run_once: true

